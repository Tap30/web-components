name: 🚀 Release

on:
  push:
    branches:
      - main

permissions:
  contents: read

jobs:
  changesets:
    name: 📋 Check Changesets
    runs-on: ubuntu-latest
    # Don't run on forks. We can and should only release from the main repo.
    if: github.repository == 'Tap30/web-components'
    permissions:
      contents: write
      pull-requests: write
      id-token: write
    outputs:
      published: ${{ steps.cs.outputs.published }}
      pr: ${{ steps.cs.outputs.pullRequestNumber }}
    steps:
      - name: ☁️ checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 🔧 setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9

      - name: 🔧 setup node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "pnpm"

      - name: 📦 install dependencies
        run: pnpm install

      - name: 🔎 Create Release PR or Publish Packages
        # The id of this step must not be "changesets", or else the step will be invisible
        # in the list of steps from the GitHub UI when the action runs (though it will still
        # run, and its output will appear in the raw logs). Unknown why this is the case,
        # see https://github.com/changesets/action/issues/149 for discussion.
        id: cs
        uses: changesets/action@v1
        with:
          title: "chore: bump versions"
          commit: "chore: bump versions"
          publish: "pnpm release"
          version: "pnpm changesets:apply"
          createGithubReleases: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  prepare-docs:
    name: ⚙️ Prepare Documentation
    runs-on: ubuntu-latest
    needs: changesets
    if: needs.changesets.outputs.published == 'true'
    steps:
      - name: ☁️ checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: 🔧 setup pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 9

      - name: 🔧 setup node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: "pnpm"
          registry-url: https://registry.npmjs.org/

      - name: 🔧 setup pages
        uses: actions/configure-pages@v4

      - name: 📦 install dependencies
        run: pnpm install

      # Set up GitHub Actions caching for Wireit.
      - name: 🔌 setup wireit cache
        uses: google/wireit@setup-github-actions-caching/v2

      - name: 🧱 build docs
        run: pnpm build:docs

      - name: 🗄️ upload pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: docs/.vitepress/dist

  deploy-docs:
    needs: prepare-docs
    name: 🚀 Deploy Docs
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: 🚀 deploy to github pages
        id: deployment
        uses: actions/deploy-pages@v4
